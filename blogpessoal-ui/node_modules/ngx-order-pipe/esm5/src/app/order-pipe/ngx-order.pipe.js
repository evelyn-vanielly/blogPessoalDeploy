import * as tslib_1 from "tslib";
import { Pipe } from "@angular/core";
var OrderPipe = /** @class */ (function () {
    function OrderPipe() {
    }
    OrderPipe_1 = OrderPipe;
    /**
     * Check if a value is a string
     *
     * @param value
     */
    OrderPipe.isString = function (value) {
        return typeof value === "string" || value instanceof String;
    };
    /**
     * Sorts values ignoring the case
     *
     * @param a
     * @param b
     */
    OrderPipe.caseInsensitiveSort = function (a, b) {
        if (OrderPipe_1.isString(a) && OrderPipe_1.isString(b)) {
            return a.localeCompare(b);
        }
        return OrderPipe_1.defaultCompare(a, b);
    };
    /**
     * Default compare method
     *
     * @param a
     * @param b
     */
    OrderPipe.defaultCompare = function (a, b) {
        if (a instanceof Date) {
            a = a.getTime();
            b = b.getTime();
        }
        if (a === b) {
            return 0;
        }
        if (a == null) {
            return 1;
        }
        if (b == null) {
            return -1;
        }
        return a > b ? 1 : -1;
    };
    /**
     * Parse expression, split into items
     * @param expression
     * @returns {string[]}
     */
    OrderPipe.parseExpression = function (expression) {
        expression = expression.replace(/\[(\w+)\]/g, ".$1");
        expression = expression.replace(/^\./, "");
        return expression.split(".");
    };
    /**
     * Get value by expression
     *
     * @param object
     * @param expression
     * @returns {any}
     */
    OrderPipe.getValue = function (object, expression) {
        for (var i = 0, n = expression.length; i < n; ++i) {
            if (!object) {
                return;
            }
            var k = expression[i];
            if (!(k in object)) {
                return;
            }
            if (typeof object[k] === "function") {
                object = object[k]();
            }
            else {
                object = object[k];
            }
        }
        return object;
    };
    /**
     * Set value by expression
     *
     * @param object
     * @param value
     * @param expression
     */
    OrderPipe.setValue = function (object, value, expression) {
        var i;
        for (i = 0; i < expression.length - 1; i++) {
            object = object[expression[i]];
        }
        object[expression[i]] = value;
    };
    OrderPipe.prototype.transform = function (value, expression, reverse, isCaseInsensitive, comparator) {
        if (isCaseInsensitive === void 0) { isCaseInsensitive = false; }
        if (!value) {
            return value;
        }
        if (Array.isArray(expression)) {
            return this.multiExpressionTransform(value, expression, reverse, isCaseInsensitive, comparator);
        }
        if (Array.isArray(value)) {
            return this.sortArray(value.slice(), expression, reverse, isCaseInsensitive, comparator);
        }
        if (typeof value === "object") {
            return this.transformObject(Object.assign({}, value), expression, reverse, isCaseInsensitive, comparator);
        }
        return value;
    };
    /**
     * Sort array
     *
     * @param value
     * @param expression
     * @param reverse
     * @param isCaseInsensitive
     * @param comparator
     * @returns {any[]}
     */
    OrderPipe.prototype.sortArray = function (value, expression, reverse, isCaseInsensitive, comparator) {
        var isDeepLink = expression && expression.indexOf(".") !== -1;
        if (isDeepLink) {
            expression = OrderPipe_1.parseExpression(expression);
        }
        var compareFn;
        if (comparator && typeof comparator === "function") {
            compareFn = comparator;
        }
        else {
            compareFn = isCaseInsensitive
                ? OrderPipe_1.caseInsensitiveSort
                : OrderPipe_1.defaultCompare;
        }
        var array = value.sort(function (a, b) {
            if (!expression) {
                return compareFn(a, b);
            }
            if (!isDeepLink) {
                if (a && b) {
                    return compareFn(a[expression], b[expression]);
                }
                return compareFn(a, b);
            }
            return compareFn(OrderPipe_1.getValue(a, expression), OrderPipe_1.getValue(b, expression));
        });
        if (reverse) {
            return array.reverse();
        }
        return array;
    };
    /**
     * Transform Object
     *
     * @param value
     * @param expression
     * @param reverse
     * @param isCaseInsensitive
     * @param comparator
     * @returns {any[]}
     */
    OrderPipe.prototype.transformObject = function (value, expression, reverse, isCaseInsensitive, comparator) {
        var parsedExpression = OrderPipe_1.parseExpression(expression);
        var lastPredicate = parsedExpression.pop();
        var oldValue = OrderPipe_1.getValue(value, parsedExpression);
        if (!Array.isArray(oldValue)) {
            parsedExpression.push(lastPredicate);
            lastPredicate = null;
            oldValue = OrderPipe_1.getValue(value, parsedExpression);
        }
        if (!oldValue) {
            return value;
        }
        OrderPipe_1.setValue(value, this.transform(oldValue, lastPredicate, reverse, isCaseInsensitive), parsedExpression);
        return value;
    };
    /**
     * Apply multiple expressions
     *
     * @param value
     * @param {any[]} expressions
     * @param {boolean} reverse
     * @param {boolean} isCaseInsensitive
     * @param {Function} comparator
     * @returns {any}
     */
    OrderPipe.prototype.multiExpressionTransform = function (value, expressions, reverse, isCaseInsensitive, comparator) {
        var _this = this;
        if (isCaseInsensitive === void 0) { isCaseInsensitive = false; }
        return expressions.reverse().reduce(function (result, expression) {
            return _this.transform(result, expression, reverse, isCaseInsensitive, comparator);
        }, value);
    };
    var OrderPipe_1;
    OrderPipe = OrderPipe_1 = tslib_1.__decorate([
        Pipe({
            name: "orderBy",
            pure: false
        })
    ], OrderPipe);
    return OrderPipe;
}());
export { OrderPipe };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW9yZGVyLnBpcGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtb3JkZXItcGlwZS8iLCJzb3VyY2VzIjpbInNyYy9hcHAvb3JkZXItcGlwZS9uZ3gtb3JkZXIucGlwZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLElBQUksRUFBaUIsTUFBTSxlQUFlLENBQUM7QUFNcEQ7SUFBQTtJQTJRQSxDQUFDO2tCQTNRWSxTQUFTO0lBQ3BCOzs7O09BSUc7SUFDSSxrQkFBUSxHQUFmLFVBQWdCLEtBQVU7UUFDeEIsT0FBTyxPQUFPLEtBQUssS0FBSyxRQUFRLElBQUksS0FBSyxZQUFZLE1BQU0sQ0FBQztJQUM5RCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSw2QkFBbUIsR0FBMUIsVUFBMkIsQ0FBTSxFQUFFLENBQU07UUFDdkMsSUFBSSxXQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLFdBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDbEQsT0FBTyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzNCO1FBQ0QsT0FBTyxXQUFTLENBQUMsY0FBYyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSx3QkFBYyxHQUFyQixVQUFzQixDQUFNLEVBQUUsQ0FBTTtRQUNsQyxJQUFJLENBQUMsWUFBWSxJQUFJLEVBQUU7WUFDbkIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNoQixDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ25CO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ1gsT0FBTyxDQUFDLENBQUM7U0FDVjtRQUNELElBQUksQ0FBQyxJQUFJLElBQUksRUFBRTtZQUNiLE9BQU8sQ0FBQyxDQUFDO1NBQ1Y7UUFDRCxJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUU7WUFD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QUUsQ0FBQyxNQUFNLENBQUMsVUFBQyxNQUFXLEVBQUUsVUFBZTtZQUMvRCxPQUFPLEtBQUksQ0FBQyxTQUFTLENBQ25CLE1BQU0sRUFDTixVQUFVLEVBQ1YsT0FBTyxFQUNQLGlCQUFpQixFQUNqQixVQUFVLENBQ1gsQ0FBQztRQUNKLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNaLENBQUM7O0lBMVFVLFNBQVM7UUFKckIsSUFBSSxDQUFDO1lBQ0osSUFBSSxFQUFFLFNBQVM7WUFDZixJQUFJLEVBQUUsS0FBSztTQUNaLENBQUM7T0FDVyxTQUFTLENBMlFyQjtJQUFELGdCQUFDO0NBQUEsQUEzUUQsSUEyUUM7U0EzUVksU0FBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBpcGUsIFBpcGVUcmFuc2Zvcm0gfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuXG5AUGlwZSh7XG4gIG5hbWU6IFwib3JkZXJCeVwiLFxuICBwdXJlOiBmYWxzZVxufSlcbmV4cG9ydCBjbGFzcyBPcmRlclBpcGUgaW1wbGVtZW50cyBQaXBlVHJhbnNmb3JtIHtcbiAgLyoqXG4gICAqIENoZWNrIGlmIGEgdmFsdWUgaXMgYSBzdHJpbmdcbiAgICpcbiAgICogQHBhcmFtIHZhbHVlXG4gICAqL1xuICBzdGF0aWMgaXNTdHJpbmcodmFsdWU6IGFueSkge1xuICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIgfHwgdmFsdWUgaW5zdGFuY2VvZiBTdHJpbmc7XG4gIH1cblxuICAvKipcbiAgICogU29ydHMgdmFsdWVzIGlnbm9yaW5nIHRoZSBjYXNlXG4gICAqXG4gICAqIEBwYXJhbSBhXG4gICAqIEBwYXJhbSBiXG4gICAqL1xuICBzdGF0aWMgY2FzZUluc2Vuc2l0aXZlU29ydChhOiBhbnksIGI6IGFueSkge1xuICAgIGlmIChPcmRlclBpcGUuaXNTdHJpbmcoYSkgJiYgT3JkZXJQaXBlLmlzU3RyaW5nKGIpKSB7XG4gICAgICByZXR1cm4gYS5sb2NhbGVDb21wYXJlKGIpO1xuICAgIH1cbiAgICByZXR1cm4gT3JkZXJQaXBlLmRlZmF1bHRDb21wYXJlKGEsIGIpO1xuICB9XG5cbiAgLyoqXG4gICAqIERlZmF1bHQgY29tcGFyZSBtZXRob2RcbiAgICpcbiAgICogQHBhcmFtIGFcbiAgICogQHBhcmFtIGJcbiAgICovXG4gIHN0YXRpYyBkZWZhdWx0Q29tcGFyZShhOiBhbnksIGI6IGFueSkge1xuICAgIGlmIChhIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICBhID0gYS5nZXRUaW1lKCk7XG4gICAgICAgIGIgPSBiLmdldFRpbWUoKTtcbiAgICB9XG4gICAgaWYgKGEgPT09IGIpIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICBpZiAoYSA9PSBudWxsKSB7XG4gICAgICByZXR1cm4gMTtcbiAgICB9XG4gICAgaWYgKGIgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIC0xO1xuICAgIH1cbiAgICByZXR1cm4gYSA+IGIgPyAxIDogLTE7XG4gIH1cblxuICAvKipcbiAgICogUGFyc2UgZXhwcmVzc2lvbiwgc3BsaXQgaW50byBpdGVtc1xuICAgKiBAcGFyYW0gZXhwcmVzc2lvblxuICAgKiBAcmV0dXJucyB7c3RyaW5nW119XG4gICAqL1xuICBzdGF0aWMgcGFyc2VFeHByZXNzaW9uKGV4cHJlc3Npb246IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICBleHByZXNzaW9uID0gZXhwcmVzc2lvbi5yZXBsYWNlKC9cXFsoXFx3KylcXF0vZywgXCIuJDFcIik7XG4gICAgZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZSgvXlxcLi8sIFwiXCIpO1xuICAgIHJldHVybiBleHByZXNzaW9uLnNwbGl0KFwiLlwiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdmFsdWUgYnkgZXhwcmVzc2lvblxuICAgKlxuICAgKiBAcGFyYW0gb2JqZWN0XG4gICAqIEBwYXJhbSBleHByZXNzaW9uXG4gICAqIEByZXR1cm5zIHthbnl9XG4gICAqL1xuICBzdGF0aWMgZ2V0VmFsdWUob2JqZWN0OiBhbnksIGV4cHJlc3Npb246IHN0cmluZ1tdKSB7XG4gICAgZm9yIChsZXQgaSA9IDAsIG4gPSBleHByZXNzaW9uLmxlbmd0aDsgaSA8IG47ICsraSkge1xuICAgICAgaWYgKCFvYmplY3QpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgayA9IGV4cHJlc3Npb25baV07XG4gICAgICBpZiAoIShrIGluIG9iamVjdCkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiBvYmplY3Rba10gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBvYmplY3QgPSBvYmplY3Rba10oKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9iamVjdCA9IG9iamVjdFtrXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gb2JqZWN0O1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB2YWx1ZSBieSBleHByZXNzaW9uXG4gICAqXG4gICAqIEBwYXJhbSBvYmplY3RcbiAgICogQHBhcmFtIHZhbHVlXG4gICAqIEBwYXJhbSBleHByZXNzaW9uXG4gICAqL1xuICBzdGF0aWMgc2V0VmFsdWUob2JqZWN0OiBhbnksIHZhbHVlOiBhbnksIGV4cHJlc3Npb246IHN0cmluZ1tdKSB7XG4gICAgbGV0IGk7XG4gICAgZm9yIChpID0gMDsgaSA8IGV4cHJlc3Npb24ubGVuZ3RoIC0gMTsgaSsrKSB7XG4gICAgICBvYmplY3QgPSBvYmplY3RbZXhwcmVzc2lvbltpXV07XG4gICAgfVxuXG4gICAgb2JqZWN0W2V4cHJlc3Npb25baV1dID0gdmFsdWU7XG4gIH1cblxuICB0cmFuc2Zvcm0oXG4gICAgdmFsdWU6IGFueSB8IGFueVtdLFxuICAgIGV4cHJlc3Npb24/OiBhbnksXG4gICAgcmV2ZXJzZT86IGJvb2xlYW4sXG4gICAgaXNDYXNlSW5zZW5zaXRpdmU6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBjb21wYXJhdG9yPzogRnVuY3Rpb25cbiAgKTogYW55IHtcbiAgICBpZiAoIXZhbHVlKSB7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZXhwcmVzc2lvbikpIHtcbiAgICAgIHJldHVybiB0aGlzLm11bHRpRXhwcmVzc2lvblRyYW5zZm9ybShcbiAgICAgICAgdmFsdWUsXG4gICAgICAgIGV4cHJlc3Npb24sXG4gICAgICAgIHJldmVyc2UsXG4gICAgICAgIGlzQ2FzZUluc2Vuc2l0aXZlLFxuICAgICAgICBjb21wYXJhdG9yXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgcmV0dXJuIHRoaXMuc29ydEFycmF5KFxuICAgICAgICB2YWx1ZS5zbGljZSgpLFxuICAgICAgICBleHByZXNzaW9uLFxuICAgICAgICByZXZlcnNlLFxuICAgICAgICBpc0Nhc2VJbnNlbnNpdGl2ZSxcbiAgICAgICAgY29tcGFyYXRvclxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcIm9iamVjdFwiKSB7XG4gICAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm1PYmplY3QoXG4gICAgICAgIE9iamVjdC5hc3NpZ24oe30sIHZhbHVlKSxcbiAgICAgICAgZXhwcmVzc2lvbixcbiAgICAgICAgcmV2ZXJzZSxcbiAgICAgICAgaXNDYXNlSW5zZW5zaXRpdmUsXG4gICAgICAgIGNvbXBhcmF0b3JcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNvcnQgYXJyYXlcbiAgICpcbiAgICogQHBhcmFtIHZhbHVlXG4gICAqIEBwYXJhbSBleHByZXNzaW9uXG4gICAqIEBwYXJhbSByZXZlcnNlXG4gICAqIEBwYXJhbSBpc0Nhc2VJbnNlbnNpdGl2ZVxuICAgKiBAcGFyYW0gY29tcGFyYXRvclxuICAgKiBAcmV0dXJucyB7YW55W119XG4gICAqL1xuICBwcml2YXRlIHNvcnRBcnJheShcbiAgICB2YWx1ZTogYW55W10sXG4gICAgZXhwcmVzc2lvbj86IGFueSxcbiAgICByZXZlcnNlPzogYm9vbGVhbixcbiAgICBpc0Nhc2VJbnNlbnNpdGl2ZT86IGJvb2xlYW4sXG4gICAgY29tcGFyYXRvcj86IEZ1bmN0aW9uXG4gICk6IGFueVtdIHtcbiAgICBjb25zdCBpc0RlZXBMaW5rID0gZXhwcmVzc2lvbiAmJiBleHByZXNzaW9uLmluZGV4T2YoXCIuXCIpICE9PSAtMTtcblxuICAgIGlmIChpc0RlZXBMaW5rKSB7XG4gICAgICBleHByZXNzaW9uID0gT3JkZXJQaXBlLnBhcnNlRXhwcmVzc2lvbihleHByZXNzaW9uKTtcbiAgICB9XG5cbiAgICBsZXQgY29tcGFyZUZuOiBGdW5jdGlvbjtcblxuICAgIGlmIChjb21wYXJhdG9yICYmIHR5cGVvZiBjb21wYXJhdG9yID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNvbXBhcmVGbiA9IGNvbXBhcmF0b3I7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbXBhcmVGbiA9IGlzQ2FzZUluc2Vuc2l0aXZlXG4gICAgICAgID8gT3JkZXJQaXBlLmNhc2VJbnNlbnNpdGl2ZVNvcnRcbiAgICAgICAgOiBPcmRlclBpcGUuZGVmYXVsdENvbXBhcmU7XG4gICAgfVxuXG4gICAgY29uc3QgYXJyYXk6IGFueVtdID0gdmFsdWUuc29ydCgoYTogYW55LCBiOiBhbnkpOiBudW1iZXIgPT4ge1xuICAgICAgaWYgKCFleHByZXNzaW9uKSB7XG4gICAgICAgIHJldHVybiBjb21wYXJlRm4oYSwgYik7XG4gICAgICB9XG5cbiAgICAgIGlmICghaXNEZWVwTGluaykge1xuICAgICAgICBpZiAoYSAmJiBiKSB7XG4gICAgICAgICAgcmV0dXJuIGNvbXBhcmVGbihhW2V4cHJlc3Npb25dLCBiW2V4cHJlc3Npb25dKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29tcGFyZUZuKGEsIGIpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gY29tcGFyZUZuKFxuICAgICAgICBPcmRlclBpcGUuZ2V0VmFsdWUoYSwgZXhwcmVzc2lvbiksXG4gICAgICAgIE9yZGVyUGlwZS5nZXRWYWx1ZShiLCBleHByZXNzaW9uKVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGlmIChyZXZlcnNlKSB7XG4gICAgICByZXR1cm4gYXJyYXkucmV2ZXJzZSgpO1xuICAgIH1cblxuICAgIHJldHVybiBhcnJheTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUcmFuc2Zvcm0gT2JqZWN0XG4gICAqXG4gICAqIEBwYXJhbSB2YWx1ZVxuICAgKiBAcGFyYW0gZXhwcmVzc2lvblxuICAgKiBAcGFyYW0gcmV2ZXJzZVxuICAgKiBAcGFyYW0gaXNDYXNlSW5zZW5zaXRpdmVcbiAgICogQHBhcmFtIGNvbXBhcmF0b3JcbiAgICogQHJldHVybnMge2FueVtdfVxuICAgKi9cbiAgcHJpdmF0ZSB0cmFuc2Zvcm1PYmplY3QoXG4gICAgdmFsdWU6IGFueSB8IGFueVtdLFxuICAgIGV4cHJlc3Npb24/OiBhbnksXG4gICAgcmV2ZXJzZT86IGJvb2xlYW4sXG4gICAgaXNDYXNlSW5zZW5zaXRpdmU/OiBib29sZWFuLFxuICAgIGNvbXBhcmF0b3I/OiBGdW5jdGlvblxuICApOiBhbnkge1xuICAgIGNvbnN0IHBhcnNlZEV4cHJlc3Npb24gPSBPcmRlclBpcGUucGFyc2VFeHByZXNzaW9uKGV4cHJlc3Npb24pO1xuICAgIGxldCBsYXN0UHJlZGljYXRlID0gcGFyc2VkRXhwcmVzc2lvbi5wb3AoKTtcbiAgICBsZXQgb2xkVmFsdWUgPSBPcmRlclBpcGUuZ2V0VmFsdWUodmFsdWUsIHBhcnNlZEV4cHJlc3Npb24pO1xuXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KG9sZFZhbHVlKSkge1xuICAgICAgcGFyc2VkRXhwcmVzc2lvbi5wdXNoKGxhc3RQcmVkaWNhdGUpO1xuICAgICAgbGFzdFByZWRpY2F0ZSA9IG51bGw7XG4gICAgICBvbGRWYWx1ZSA9IE9yZGVyUGlwZS5nZXRWYWx1ZSh2YWx1ZSwgcGFyc2VkRXhwcmVzc2lvbik7XG4gICAgfVxuXG4gICAgaWYgKCFvbGRWYWx1ZSkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIE9yZGVyUGlwZS5zZXRWYWx1ZShcbiAgICAgIHZhbHVlLFxuICAgICAgdGhpcy50cmFuc2Zvcm0ob2xkVmFsdWUsIGxhc3RQcmVkaWNhdGUsIHJldmVyc2UsIGlzQ2FzZUluc2Vuc2l0aXZlKSxcbiAgICAgIHBhcnNlZEV4cHJlc3Npb25cbiAgICApO1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseSBtdWx0aXBsZSBleHByZXNzaW9uc1xuICAgKlxuICAgKiBAcGFyYW0gdmFsdWVcbiAgICogQHBhcmFtIHthbnlbXX0gZXhwcmVzc2lvbnNcbiAgICogQHBhcmFtIHtib29sZWFufSByZXZlcnNlXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNDYXNlSW5zZW5zaXRpdmVcbiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29tcGFyYXRvclxuICAgKiBAcmV0dXJucyB7YW55fVxuICAgKi9cbiAgcHJpdmF0ZSBtdWx0aUV4cHJlc3Npb25UcmFuc2Zvcm0oXG4gICAgdmFsdWU6IGFueSxcbiAgICBleHByZXNzaW9uczogYW55W10sXG4gICAgcmV2ZXJzZTogYm9vbGVhbixcbiAgICBpc0Nhc2VJbnNlbnNpdGl2ZTogYm9vbGVhbiA9IGZhbHNlLFxuICAgIGNvbXBhcmF0b3I/OiBGdW5jdGlvblxuICApOiBhbnkge1xuICAgIHJldHVybiBleHByZXNzaW9ucy5yZXZlcnNlKCkucmVkdWNlKChyZXN1bHQ6IGFueSwgZXhwcmVzc2lvbjogYW55KSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm0oXG4gICAgICAgIHJlc3VsdCxcbiAgICAgICAgZXhwcmVzc2lvbixcbiAgICAgICAgcmV2ZXJzZSxcbiAgICAgICAgaXNDYXNlSW5zZW5zaXRpdmUsXG4gICAgICAgIGNvbXBhcmF0b3JcbiAgICAgICk7XG4gICAgfSwgdmFsdWUpO1xuICB9XG59XG4iXX0=